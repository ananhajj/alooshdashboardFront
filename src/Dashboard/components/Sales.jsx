import React, { useState, useContext } from "react";
import {
  Search,
  Plus,
  Minus,
  ShoppingCart,
  CreditCard,
  Banknote,
  Plus as PlusIcon,
} from "lucide-react";
import Swal from "sweetalert2";
import InvoicePrint from "./InvoicePrint";
import CartSection from "./CartSection";
import { PublicContext } from "../context/publicContext";
import html2canvas from "html2canvas";
import { createRoot } from "react-dom/client";
import axios from "axios";
import Loading from "../Loading/Loading";

const Sales = () => {
  const {
    products,
    setProducts,
    categories,
    setCategories,
    loading,
    setLoading,
    refreshData
  } = useContext(PublicContext);

  const [searchTerm, setSearchTerm] = useState("");
  const [selectedCategory, setSelectedCategory] = useState("");
  const [cart, setCart] = useState([]);
  const [showInvoice, setShowInvoice] = useState(false);
  const [showPaymentModal, setShowPaymentModal] = useState(false);
  const [currentInvoice, setCurrentInvoice] = useState(null);
  const [paymentMethod, setPaymentMethod] = useState("cash");
  const [customerInfo, setCustomerInfo] = useState({
    name: "",
    phone: "",
  });
  const [customPayments, setCustomPayments] = useState([]);
  const [newPayment, setNewPayment] = useState({ amount: "", dueDate: "" });
  const [initialPayment, setInitialPayment] = useState(0);
  const storedToken = localStorage.getItem("token") || sessionStorage.getItem("token");

  const validToken = storedToken;
  const addToCart = (product) => {
    if (product.unitType === "METER") {
      Swal.fire({
        title: "ÿßÿÆÿ™ÿ± ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿ®Ÿäÿπ",
        text: "ŸáŸÑ ÿ™ÿ±ŸäÿØ ÿßŸÑÿ®Ÿäÿπ ÿ®ÿßŸÑŸÖÿ™ÿ± ÿ£ŸÖ ÿ®ÿßŸÑÿ±ÿ®ÿ∑ÿ©ÿü",
        icon: "question",
        showDenyButton: true,
        showCancelButton: true,
        confirmButtonText: "üü¢ ÿ®Ÿäÿπ ÿ®ÿßŸÑŸÖÿ™ÿ±",
        denyButtonText: "üü° ÿ®Ÿäÿπ ÿ®ÿßŸÑÿ±ÿ®ÿ∑ÿ©",
        cancelButtonText: "‚ùå ÿ•ŸÑÿ∫ÿßÿ°",
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: "üü¢ ÿ£ÿØÿÆŸÑ ÿπÿØÿØ ÿßŸÑÿ£ŸÖÿ™ÿßÿ± ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©",
            input: "number",
            inputAttributes: {
              min: "0.1",
              step: "0.1",
              max: product.quantityInMeters,
            },
            showCancelButton: true,
            confirmButtonText: "ÿ•ÿ∂ÿßŸÅÿ©",
            cancelButtonText: " ÿ•ŸÑÿ∫ÿßÿ°",
          }).then((meterResult) => {
            if (meterResult.isConfirmed) {
              const meters = parseFloat(meterResult.value);

              const existingItem = cart.find(
                (item) =>
                  item.product.productId === product.productId &&
                  item.unit === "meter"
              );

              if (existingItem) {
                setCart(
                  cart.map((item) =>
                    item.product.productId === product.productId &&
                    item.unit === "meter"
                      ? { ...item, quantity: item.quantity + meters }
                      : item
                  )
                );
              } else {
                setCart([
                  ...cart,
                  { product, quantity: meters, unit: "meter" },
                ]);
              }
            }
          });
        } else if (result.isDenied) {
          Swal.fire({
            title: "üü° ÿ£ÿØÿÆŸÑ ÿπÿØÿØ ÿßŸÑÿ±ÿ®ÿ∑ÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©",
            input: "number",
            inputAttributes: {
              min: "1",
              step: "1",
              max: product.quantity,
            },
            showCancelButton: true,
            confirmButtonText: "ÿ•ÿ∂ÿßŸÅÿ©",
            cancelButtonText: " ÿ•ŸÑÿ∫ÿßÿ°",
          }).then((rollResult) => {
            if (rollResult.isConfirmed) {
              const rolls = parseInt(rollResult.value, 10);

              const existingItem = cart.find(
                (item) =>
                  item.product.productId === product.productId &&
                  item.unit === "roll"
              );

              if (existingItem) {
                setCart(
                  cart.map((item) =>
                    item.product.productId === product.productId &&
                    item.unit === "roll"
                      ? { ...item, quantity: item.quantity + rolls }
                      : item
                  )
                );
              } else {
                setCart([...cart, { product, quantity: rolls, unit: "roll" }]);
              }
            }
          });
        }
      });
    } else {
      const existingItem = cart.find(
        (item) =>
          item.product.productId === product.productId && item.unit === "piece"
      );

      if (existingItem) {
        setCart(
          cart.map((item) =>
            item.product.productId === product.productId &&
            item.unit === "piece"
              ? { ...item, quantity: item.quantity + 1 }
              : item
          )
        );
      } else {
        setCart([...cart, { product, quantity: 1, unit: "piece" }]);
      }
    }
  };

  const addCustomPayment = () => {
    if (!newPayment.amount || !newPayment.dueDate) {
      Swal.fire("ÿÆÿ∑ÿ£", "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÖÿ®ŸÑÿ∫ Ÿàÿ™ÿßÿ±ŸäÿÆ ÿµÿ≠Ÿäÿ≠!", "error");
      return;
    }

    let totalPaid =
      customPayments.reduce((sum, p) => sum + Number(p.amount), 0) +
      Number(newPayment.amount) +
      initialPayment; // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ© ŸÑŸÑÿ≠ÿ≥ÿßÿ®

    let remaining = calculateTotals().total - totalPaid;

    if (remaining < 0) {
      Swal.fire(
        "ÿÆÿ∑ÿ£",
        "ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™ ŸÑÿß ŸäŸÖŸÉŸÜ ÿ£ŸÜ Ÿäÿ™ÿ¨ÿßŸàÿ≤ ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä!",
        "error"
      );
      return;
    }

    setCustomPayments([...customPayments, { ...newPayment, status: "pending" }]);
    setNewPayment({ amount: "", dueDate: "" });
  };

  const removeCustomPayment = (index) => {
    let updatedPayments = customPayments.filter((_, i) => i !== index);
    setCustomPayments(updatedPayments);
  };

  const updateQuantity = (productId, newQuantity) => {
    setCart(
      cart
        .map((item) => {
          if (item.product.productId === productId) {
            const maxStock =
              item.unit === "meter"
                ? item.product.quantityInMeters
                : item.product.quantity;

            if (newQuantity > maxStock) {
              return { ...item, quantity: maxStock };
            }

            if (newQuantity < 1) {
              return null;
            }

            return { ...item, quantity: newQuantity };
          }
          return item;
        })
        .filter(Boolean)
    );
  };

  const calculateTotals = (discount = 0) => {
    const subtotal = cart.reduce((sum, item) => {
      if (item.unit === "meter") {
        return sum + item.quantity * item.product.pricePerMeters;
      } else {
        return sum + item.quantity * item.product.price;
      }
    }, 0);
    localStorage.setItem("subtotal", subtotal);
    const total = subtotal - discount;
    localStorage.setItem("total", total);
    return { total, subtotal };
  };

  const handleCheckout = () => {
    if (cart.length === 0) {
      Swal.fire("ÿ™ŸÜÿ®ŸäŸá!", "ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ±ÿ∫ÿ©", "warning");
      return;
    }
    setShowPaymentModal(true);
  };

  const handlePaymentSubmit = () => {
    const total = Number(localStorage.getItem("total"));
    const subtotal = Number(localStorage.getItem("subtotal"));

    if (!customerInfo.name || !customerInfo.phone) {
      Swal.fire("ÿÆÿ∑ÿ£", "Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿ° ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©!", "error");
      return;
    }
    if (paymentMethod === "payments" && customPayments.length === 0) {
      Swal.fire("ÿÆÿ∑ÿ£", "Ÿäÿ¨ÿ® ÿ•ÿ∂ÿßŸÅÿ© ÿØŸÅÿπÿ© Ÿàÿßÿ≠ÿØÿ© ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ!", "error");
      return;
    }

    let paymentDetails = {
      payments: paymentMethod === "cash" ? [] : customPayments,
     
    };

    const invoiceData = {
      method:paymentMethod,
      date: new Date().toLocaleDateString("ar"),
      items: cart.map((item) => {
        const isMeterUnit = item.unit === "meter";
        return {
          productId: item.product.productId,
          name: item.product.name,
          price: isMeterUnit ? item.product.pricePerMeters : item.product.price,
          quantity: item.quantity,
          unit: item.unit,
          totalPrice: isMeterUnit
            ? item.quantity * item.product.pricePerMeters
            : item.quantity * item.product.price,
        };
      }),
      subtotal: subtotal,
      total: total,
      customer: customerInfo,
      payment: {
        initialPayment: initialPayment,
         paymentDetails,
      }
    };

    setCurrentInvoice(invoiceData);
    setShowPaymentModal(false);
    setShowInvoice(true);
    setCart([]);
    setCustomPayments([]);
  };



 
  const sendInvoiceToBackend = async () => {
    let  filteredInvoice={};
    if(paymentMethod=='cash'){
     filteredInvoice = {
      invoiceNumber: currentInvoice.invoiceNumber,
      customerName: currentInvoice.customer.name,
      customerPhone: currentInvoice.customer.phone,
      subtotal: currentInvoice.subtotal,
      total: currentInvoice.total,
      paymentMethod: currentInvoice?.method
        ? currentInvoice.method.toUpperCase()
        : "UNKNOWN",
      items: currentInvoice.items.map((item) => {
  
        const quantityInMeter = item.unit === "meter" ? item.quantity : null;

        return {
          productId: item.productId,
          quantity: item.unit === "meter" ? null : item.quantity,  
          quantityInMeter,  
        };
      }),


    };
  }
    else{
      filteredInvoice = {
        invoiceNumber: currentInvoice.invoiceNumber,
        customerName: currentInvoice.customer.name,
        customerPhone: currentInvoice.customer.phone,
        subtotal: currentInvoice.subtotal,
        total: currentInvoice.total,
        initialPayment: currentInvoice.payment?.initialPayment,
        payments: currentInvoice.payment.paymentDetails.payments.map((payment) => ({
          amount: payment.amount,
          paymentDate: payment.dueDate,
        })),
        paymentMethod: currentInvoice?.method
          ? currentInvoice.method.toUpperCase()
          : "UNKNOWN",
        items: currentInvoice.items.map((item) => {

          const quantityInMeter = item.unit === "meter" ? item.quantity : null;

          return {
            productId: item.productId,
            quantity: item.unit === "meter" ? null : item.quantity,
            quantityInMeter,
          };
        }),


      };
    
  }
    setLoading(true);
    try {
      const response = await axios.post("https://alooshbackend-production.up.railway.app/api/invoice", filteredInvoice);

      Swal.fire({
        title: "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©!",
        text: "ÿ™ŸÖÿ™ ÿßŸÑÿπŸÖŸÑŸäÿ© ÿ®ŸÜÿ¨ÿßÿ≠.",
        icon: "success",
        confirmButtonText: "ÿ≠ÿ≥ŸÜÿßŸã",
      });

       setShowInvoice(false);
    } catch (error) {
      Swal.fire({
        title: "ÿÆÿ∑ÿ£!",
        text: "ŸÅÿ¥ŸÑ ŸÅŸä ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©. ÿßŸÑÿ±ÿ¨ÿßÿ° ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÑÿßÿ≠ŸÇŸãÿß.",
        icon: "error",
        confirmButtonText: "ŸÖŸàÿßŸÅŸÇ",
      });

      console.error("ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©:", error.response?.data || error.message);
    }finally{
      setLoading(false);
    }
  };

  const generateJPG = async (container) => {
    return new Promise((resolve, reject) => {
      setTimeout(async () => {
        try {
          const canvas = await html2canvas(container, {
            scale: 2, // ÿ™ÿ≠ÿ≥ŸäŸÜ ÿßŸÑÿ¨ŸàÿØÿ©
            useCORS: true, // ÿØÿπŸÖ ÿßŸÑÿµŸàÿ± ÿßŸÑÿÆÿßÿ±ÿ¨Ÿäÿ©
            windowWidth: 754.672,
            windowHeight: container.scrollHeight,
          });

          const imgData = canvas.toDataURL("image/jpeg", 0.9); // ÿßŸÑÿ¨ŸàÿØÿ© 90%

          const byteCharacters = atob(imgData.split(",")[1]);
          const byteNumbers = new Array(byteCharacters.length);
          for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
          }
          const byteArray = new Uint8Array(byteNumbers);
          const imgBlob = new Blob([byteArray], { type: "image/jpeg" });

          resolve({ imgBlob, fileName: `invoice-${currentInvoice.invoiceNumber}.jpg` });
        } catch (error) {
          console.error("Error generating JPG:", error);
          reject(error);
        }
      }, 500);
    });
  };

  const handleDownload = async () => {
    const container = document.createElement("div");
    document.body.appendChild(container);

    const root = createRoot(container);
    root.render(<InvoicePrint invoice={currentInvoice} />);

    try {
      const { imgBlob, fileName } = await generateJPG(container);

      // ÿ•ŸÜÿ¥ÿßÿ° ÿ±ÿßÿ®ÿ∑ ŸÑÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸàÿ±ÿ©
      const link = document.createElement("a");
      const imageUrl = URL.createObjectURL(imgBlob);

      link.href = imageUrl;
      link.download = fileName; // ÿßÿ≥ŸÖ ÿßŸÑŸÖŸÑŸÅ ÿßŸÑÿ∞Ÿä ÿ≥Ÿäÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑŸá
      link.click(); // ÿ™ŸÜŸÅŸäÿ∞ ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ

      // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÄ DOM ÿ®ÿπÿØ ÿßŸÑÿπŸÖŸÑŸäÿ©
      root.unmount();
      document.body.removeChild(container);
    } catch (error) {
      console.error("Error during download process:", error);
    }
  };



  const handlePrintAndSend = async () => {
    try {
      
      await sendInvoiceToBackend();

   
      handleDownload();

   
      refreshData();

 
      localStorage.removeItem("total");
      localStorage.removeItem("subtotal");

    } catch (error) {
      console.error("Error occurred:", error);
 
    }
  };


  const filteredProducts = products.filter((product) => {
    const matchesSearch =
      product.name.includes(searchTerm) || product.code?.includes(searchTerm);
    const matchesCategory =
      !selectedCategory ||
      Number(product.categoryId) === Number(selectedCategory);
    return matchesSearch && matchesCategory;
  });

  if(loading){
    return(
      <Loading/>
    )
  }
  return (
    <>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2">
          <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-lg p-6">
            <div className="flex flex-col md:flex-row gap-4 mb-6">
              <div className="relative w-full md:w-2/3">
                <Search
                  className="absolute right-4 top-3 text-gray-400 dark:text-gray-300"
                  size={20}
                />
                <input
                  type="text"
                  placeholder="ÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-4 pr-12 py-2 border border-gray-300 dark:border-gray-700 rounded-xl bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                />
              </div>
              <select
                className="w-full md:w-1/3 border border-gray-300 dark:border-gray-700 rounded-xl px-4 py-2 bg-white dark:bg-gray-700 dark:text-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition"
                value={selectedCategory}
                onChange={(e) => setSelectedCategory(e.target.value)}
              >
                <option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ¶ÿßÿ™</option>
                {categories.map((category) => (
                  <option key={category.categoryId} value={category.categoryId}>
                    {category.categoryName}
                  </option>
                ))}
              </select>
            </div>
            <div className="max-h-[600px] overflow-y-auto px-2">

            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              {filteredProducts
                .filter((product) =>
                  product.unitType === "METER"
                    ? product.quantity > 0 || product.quantityInMeters > 0
                    : product.quantity > 0
                )
                .map((product) => (
                  <div
                    key={product.productId}
                    className="border border-gray-300 dark:border-gray-700 rounded-2xl p-4 shadow-md hover:shadow-lg transition duration-300 bg-white dark:bg-gray-800"
                  >
                    {product.imageUrl && (
                      <div className="overflow-hidden rounded-xl mb-3">
                        <img
                          src={product.imageUrl}
                          alt={product.name}
                          className="w-full aspect-[4/3] object-cover transition-transform transform hover:scale-105"
                        />
                      </div>
                    )}

                    <h3 className="font-semibold text-lg text-gray-900 dark:text-gray-100 mb-1">
                      {product.name}
                    </h3>
                    <p className="text-sm text-gray-500 dark:text-gray-400">
                      ÿßŸÑŸÉŸÖŸäÿ© ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©:{" "}
                      {product.unitType === "METER"
                        ? `${product.quantityInMeters} ŸÖÿ™ÿ± ${
                            product.quantity > 0
                              ? `(${product.quantity} ÿ±ÿ®ÿ∑ÿ©)`
                              : ""
                          }`
                        : `${product.quantity} ŸÇÿ∑ÿπÿ©`}
                    </p>

                    <div className="mt-2 text-sm text-gray-700 dark:text-gray-300 space-y-1">
                      {product.unitType === "METER" ? (
                        <>
                          <p>üí∞ ÿ≥ÿπÿ± ÿßŸÑÿ±ÿ®ÿ∑ÿ©: {product.price} ÿ¥ŸäŸÉŸÑ</p>
                          <p>üìè ÿ≥ÿπÿ± ÿßŸÑŸÖÿ™ÿ±: {product.pricePerMeters} ÿ¥ŸäŸÉŸÑ</p>
                          <p className="text-green-600 dark:text-green-400 font-medium">
                            ‚úÖ Ÿäÿ®ÿßÿπ ÿ®ÿßŸÑŸÖÿ™ÿ± ÿ£Ÿà ÿ®ÿßŸÑÿ±ÿ®ÿ∑ÿ©
                          </p>
                        </>
                      ) : (
                        <>
                          <p>üí∞ ÿ≥ÿπÿ± ÿßŸÑŸÇÿ∑ÿπÿ©: {product.price} ÿ¥ŸäŸÉŸÑ</p>
                          <p className="text-blue-600 dark:text-blue-400 font-medium">
                            ‚úÖ Ÿäÿ®ÿßÿπ ŸÉŸÇÿ∑ÿπÿ©
                          </p>
                        </>
                      )}
                    </div>

                    <div className="flex items-center justify-between mt-4">
                      <button
                        onClick={() => addToCart(product)}
                        className="p-2 bg-blue-500 dark:bg-blue-700 text-white rounded-xl hover:bg-blue-600 dark:hover:bg-blue-800 transition flex items-center gap-1"
                      >
                        <Plus size={18} />{" "}
                        <span className="text-sm">ÿ£ÿ∂ŸÅ ŸÑŸÑÿ≥ŸÑÿ©</span>
                      </button>
                    </div>
                  </div>
                ))}
            </div>
</div>
          </div>
        </div>

        <CartSection
          cart={cart}
          updateQuantity={updateQuantity}
          calculateTotals={(discount) => calculateTotals(discount)}
          handleCheckout={handleCheckout}
        />
      </div>

      {showPaymentModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
          <div className="bg-white dark:bg-gray-800 rounded-lg shadow-lg w-full max-w-2xl p-6 space-y-6">
            <h3 className="text-xl font-bold text-center text-gray-800 dark:text-white">ÿ™ŸÅÿßÿµŸäŸÑ ÿßŸÑÿØŸÅÿπ</h3>

            {/* ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑÿπŸÖŸäŸÑ */}
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-200">ÿßÿ≥ŸÖ ÿßŸÑÿπŸÖŸäŸÑ</label>
                <input
                  type="text"
                  className="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                  value={customerInfo.name}
                  onChange={(e) =>
                    setCustomerInfo({ ...customerInfo, name: e.target.value })
                  }
                  required 
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-200">ÿ±ŸÇŸÖ ÿßŸÑŸáÿßÿ™ŸÅ</label>
                <input
                  type="tel"
                  className="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                  value={customerInfo.phone}
                  onChange={(e) =>
                    setCustomerInfo({ ...customerInfo, phone: e.target.value })
                  }
                  required
                />
              </div>
            </div>

            {/* ÿ∑ÿ±ŸÇ ÿßŸÑÿØŸÅÿπ */}
            <div className="grid grid-cols-2 gap-6 mb-6">
              <button
                className={`p-4 border rounded-lg flex flex-col items-center gap-2 transition-colors duration-300 ${paymentMethod === "cash" ? "border-blue-500 bg-blue-50 dark:bg-blue-900 dark:text-white" : "hover:bg-gray-50 dark:hover:bg-gray-600"
                  }`}
                onClick={() => {
                  setPaymentMethod("cash");
                  setCustomPayments([]);
                }}
              >
                <Banknote className="text-blue-600" />
                <span>ŸÜŸÇÿØŸä</span>
              </button>
              <button
                className={`p-4 border rounded-lg flex flex-col items-center gap-2 transition-colors duration-300 ${paymentMethod === "installments" ? "border-blue-500 bg-blue-50 dark:bg-blue-900 dark:text-white" : "hover:bg-gray-50 dark:hover:bg-gray-600"
                  }`}
                onClick={() => setPaymentMethod("installments")}
              >
                <CreditCard className="text-blue-600" />
                <span>ÿØŸÅÿπÿßÿ™</span>
              </button>
            </div>

            {/* ŸÜÿ∏ÿßŸÖ ÿßŸÑÿØŸÅÿπÿßÿ™ */}
            {paymentMethod === "installments" && (
              <div className="space-y-6">
                {/* ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ© */}
                <div>
                  <label className="block text-sm font-medium mb-1 text-gray-600 dark:text-gray-200">ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ©</label>
                  <input
                    type="number"
                    className="w-full border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                    placeholder="ÿ£ÿØÿÆŸÑ ÿßŸÑÿØŸÅÿπÿ© ÿßŸÑÿ£ŸàŸÑŸäÿ©"
                    value={initialPayment}
                    onChange={(e) => setInitialPayment(Number(e.target.value))}
                  />
                </div>

                {/* ÿ¨ÿØŸàŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™ */}
                <div className="flex items-center justify-between mb-4">
                  <p className="text-sm text-gray-600 dark:text-gray-200">
                    ÿßŸÑŸÖÿ®ŸÑÿ∫ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸä: {calculateTotals().total} ÿ¥ŸäŸÉŸÑ
                  </p>
                  <p className="text-sm text-gray-600 dark:text-gray-200">
                    ÿßŸÑŸÖÿ™ÿ®ŸÇŸä:{" "}
                    {calculateTotals().total -
                      initialPayment -
                      customPayments.reduce((sum, p) => sum + Number(p.amount), 0)}{" "}
                    ÿ¥ŸäŸÉŸÑ
                  </p>
                </div>

                {/* ÿ•ÿØÿÆÿßŸÑ ÿØŸÅÿπÿ© ÿ¨ÿØŸäÿØÿ© */}
                <div className="flex gap-4 mb-4">
                  <input
                    type="number"
                    placeholder="ÿßŸÑŸÖÿ®ŸÑÿ∫"
                    className="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                    value={newPayment.amount}
                    onChange={(e) => setNewPayment({ ...newPayment, amount: e.target.value })}
                  />
                  <input
                    type="date"
                    className="flex-1 border rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-gray-700 dark:text-white dark:border-gray-600"
                    value={newPayment.dueDate}
                    onChange={(e) => setNewPayment({ ...newPayment, dueDate: e.target.value })}
                  />
                  <button
                    onClick={addCustomPayment}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 dark:bg-blue-800 dark:hover:bg-blue-700"
                    disabled={!initialPayment || initialPayment <= 0}
                  >
                    <PlusIcon size={16} />
                    ÿ•ÿ∂ÿßŸÅÿ© ÿØŸÅÿπÿ©
                  </button>
                </div>

                {/* ÿ¨ÿØŸàŸÑ ÿßŸÑÿØŸÅÿπÿßÿ™ */}
                {customPayments.length > 0 && (
                  <div className="border rounded-lg overflow-hidden dark:border-gray-600">
                    <table className="w-full table-auto">
                      <thead className="bg-gray-50 dark:bg-gray-700">
                        <tr>
                          <th className="px-4 py-2 text-right text-sm font-medium text-gray-600 dark:text-gray-200">ÿßŸÑÿØŸÅÿπÿ©</th>
                          <th className="px-4 py-2 text-right text-sm font-medium text-gray-600 dark:text-gray-200">ÿßŸÑŸÖÿ®ŸÑÿ∫</th>
                          <th className="px-4 py-2 text-right text-sm font-medium text-gray-600 dark:text-gray-200">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßÿ≥ÿ™ÿ≠ŸÇÿßŸÇ</th>
                          <th className="px-4 py-2 text-right text-sm font-medium text-gray-600 dark:text-gray-200">ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™</th>
                        </tr>
                      </thead>
                      <tbody className="divide-y dark:divide-gray-600">
                        {customPayments.map((payment, index) => (
                          <tr key={index}>
                            <td className="px-4 py-2 text-sm">{`ÿØŸÅÿπÿ© ${index + 1}`}</td>
                            <td className="px-4 py-2 text-sm">{payment.amount} ÿ¥ŸäŸÉŸÑ</td>
                            <td className="px-4 py-2 text-sm">{payment.dueDate}</td>
                            <td className="px-4 py-2 text-sm">
                              <button
                                onClick={() => removeCustomPayment(index)}
                                className="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
                              >
                                ÿ≠ÿ∞ŸÅ
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                )}
              </div>
            )}

            {/* ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± */}
            <div className="flex justify-end gap-4">
              <button
                onClick={() => setShowPaymentModal(false)}
                className="px-6 py-3 border rounded-lg hover:bg-gray-50 text-sm text-gray-700 dark:text-gray-200 dark:hover:bg-gray-600"
              >
                ÿ•ŸÑÿ∫ÿßÿ°
              </button>
              <button
                onClick={handlePaymentSubmit}
                className="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm dark:bg-blue-800 dark:hover:bg-blue-700"
                disabled={
                  paymentMethod !== "cash" &&
                  calculateTotals().total - initialPayment - customPayments.reduce(
                    (sum, p) => sum + Number(p.amount),
                    0
                  ) > 0
                }
              >
                ÿ™ÿ£ŸÉŸäÿØ
              </button>
            </div>
          </div>
        </div>
      )}



      {showInvoice && currentInvoice && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-lg w-full max-w-5xl">
            <div className="p-6 border-b bg-gray-50">
              <div className="flex justify-between items-center">
                <h3 className="text-2xl font-semibold text-gray-800">
                  ŸÖÿπÿßŸäŸÜÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                </h3>

                <div className="flex space-x-6 gap-2">
                  <button
                    onClick={handlePrintAndSend}
                    className="bg-green-600 text-white py-2 px-8 rounded-xl shadow-md hover:bg-green-700 transition-all"
                  >
                    ÿ∑ÿ®ÿßÿπÿ© ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ© Ÿàÿ≠ŸÅÿ∏Ÿáÿß
                  </button>

                  <button
                    onClick={() => {
                      setCurrentInvoice(null);
                      setCustomerInfo({
                        name: "",
                        phone: "",
                      });
                      setShowPaymentModal(false);
                      setShowInvoice(false);
                      setCart([]);
                      setCustomPayments([]);
                    }}
                    className="bg-red-600 text-white py-2 px-8 rounded-xl shadow-md hover:bg-red-700 transition-all ease-in-out duration-200"
                  >
                    ÿ≠ÿ∞ŸÅ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©
                  </button>
                </div>
              </div>
            </div>

            <div
              className="p-6 overflow-auto max-h-[80vh]"
              id="invoice-content"
            >
              <InvoicePrint invoice={currentInvoice} />
            </div>
          </div>
        </div>
      )}
    </>
  );
};
export default Sales;
